# Nanopore_Microbiome_WEHI_cjw
# Microbiome analysis via nanopore-sequenced amplicon data
# Code underpinning draft paper Feb 2024 
# cjw      07 February 2024
Notes for the processing of Nanopore-sequenced Zymo D6322 Mock Microbiome data as 
generated by Sereika et al. to assess the feasibility of sub-species bacterial microbiota 
profiling.  This is support material for the document 
  Full 16S and 23S rRNA gene-based,strain-level resolution of the microbiota of a mock 
  bacterial microbiome using ONT nanopore sequencing.
Authors:-
           Christopher J. Woodruff, Zhengming Zhang and Terence P. Speed
           
There are 3 parts to the processing:-
   1. Generation of 16S and 23 rRNA reference databases;
   2. Extraction of 16S and 23S rRNA gene DNA sequences from a ONT-nanopore-sequenced 
      metagenomic data for the Zymo D6322 mock microbiome to give primary and sub-sampled
      datasets.
   3. Processing of the datasets through denoising, alignment to the relevant reference 
      databases, and use of alignment data to identify and quantify the microbiota.
      
These notes provide guidance on using the code deposited on Github and the various files
provided via Figshare to trace the computational steps and results underpinning the 
material presented in the paper and its Additional Files/Supplementary Data. 

PART 1: Database Generation.
        A set of genome sequences that includes the genomic sequences of the D6322 
        bacteria is sourced. In our case we included approximately 10 additional genomes
        for each D63222 species, randomly selected from those available in NCBI Refseq.
        
        The R script   identify_extract_rrnOperons_workDB_v01.R     is executed to extract
        the 16S and 23S sequences (and Z2 and Z5 sequences should those be of interest) of
        each genome.  This script requires the additional script
        
              rrn_operon_in_silico_16S_ITS_23S_primers_30May2023.R
              
        Some characterisation of the extracted sequences for each genome is provided by 
        
                   unique_operons_count.R
                   
        which generates information subsequently used in PART 3.
        
        Actual formation of the blastn database requires a fasta file containing all the 
        sequences of interest, and these sequences must have headers that are no longer 
        than 50 characters.  The code 
        
                   fasta_header_trimmer_for_blastn.R
                   
        trims the headers of fasta sequences to <50 characters as required for blastn 
        databases.
        
        Suppose a fasta file has been created that has the sequences of all 16S rRNA genes
        of interest, and it has the name  my16SworkDB.  The call 
        
             makeblastdb -in my16SworkDB -dbtype nucl -parse_seqids
                      
        will create the set of files that constitute the required blastn database.
        
        Relevant input or output files available from Figshare are 
           a. workDB1_16S_fasta_03022024.tar
                 - has 81 files of 16S rRNA gene sequences derived from selected strains of the D6322 mock 
                    microbiome which are then concatenated and used as input to makeblastb to generate the 
                    blastn database primary input from  to RAD of the rRNA gene sequences  extracted.
           b. workDB1_16S_23S_blastn_databases.tar
                 - for both 16S and 23S gives all rRNA gene sequences for each strain, a concatenation of 
                   these for building the blastn database using makeblastdb, and the set of files that constitute 
                   the blastn database.  Also includes an .RData file (input to R) giving alignment-based data
                   on within-strain identity and difference between rRNA gene sequences.         
            


PART 2: Dataset Generation.
        No suitable 16S and 23S rRNA gene datasets created with Oxford Nanopore Technoly's R10.4.1 system were available. However an in-silico method to obtain a useful approximation to what could be produced was created to process a metagenomic dataset developed by Sereika et al (M.Sereika et al. NAR July 2022)
        The datasets generated for this study consisted of 5 16S datasets and 5 
        corresponding 23S datasets.  
        Consider the 16S datasets.  A primary dataset was formed by extracting a 16S rRNA 
        gene sequence from any read found to have one. The Rscript
        
            extract_Sereika_16S23S_v10.R
            
        which required
                        rrn_operon_in_silico_16S_ITS_23S_primers_04Aug2021.R
                        
        generates fastq files for each of 16S and 23S rRNA gene sequences.  The 16S fastq
        file contains records from any read that was found to have a complete 16S sequence,
        and likewwise for the 23S.  These files are subsequently used as input to the 
        denoiser, RAD (see PART 3).  They are considered the primary datasets in this 
        study.
        
        An additional 4 sub-sampled datasets are generated for each of the 16S and 23S 
        primary dataset.  The sub-sampling code is     
         
            subsample_D6322_fastq_v10.R
            
        This cannot be run until the relevant primary dataset has been processed through
        RAD which outputs a fastq file of reads meeting the length and quality criteria
        specified in the call of RAD.  In this study we have set 4 different sub-sampling
        specifications, common to both the 16S and 23S sub-sampling.
        
        Note that this code is very demanding of computational resources.  As written a 
        block of 250,000 reads of the Sereika et al. D6322 metagenomic dataset takes 
        about 1 hour to run using 56 cores on an HPC cluster.  It is expected that this 
        code would be unnecessary for users as the generation of amplicon sequences would 
        be via laboratory methods and nanopore sequencing of a library prepared from 
        genomic DNA.
             
        Relevant input or output files available from Figshare are:-
            i. amplicon_D6322_ primary_16S23S_fastq_05022024.tar
                 - has the 16S and 23S output from extract_Sereika_16S23S_v10.R that is the 
                   primary input to RAD for the D6322 mock microbiome analyses.
           ii. amplicon_16S_RADfastqoutput_05022024.tar (also ....23S.....tar)
                 - returns 16S fastq output from RAD processing. The first of 5 files is from the 
                   D6322 primary dataset and so is the necessary input to  subsample_D6322_fastq_v10.R
                   to allow subsampling.

PART 3: Denoising, ASV alignment, Microbiota Profiling.
        Denoising uses the Murrell labs RAD denoiser, which is written in Julia.  A script
        for doing this was generously provided by Ben Murrell and modified to provide 
        additional output by the lead author of this paper.  That script is 
        
                             RADSereika.ipynb
             
        The script is edited to give the names of the input fastq file of noisy reads, and 
        the various output files, successively for each dataset. 
        
        The RAD output from processing each dataset is used as input to the Rcode 
        
            species_strain_analysis_residualAmbiguity_v02.R
            
        This code aligns each Amplicon Sequence Variant from RAD against every entry in 
        the appropriate database (16S or 23S), using blastn running locally.  The blastn
        output is then processed to estimate the identity and relative abundances of 
        strains present.  This analysis constitutes the core of this study.
        
        Relevant input or output files available from Figshare are:-
             i. amplicon_16S_RADfastqinput_subsampledDatasets_05022024.tar
                 - gives the required .fastq input for RAD processing of the subsampled datasets
            ii. RAD_amplicon_16S23S_05022024_10dataets_text_output_06022024.tar
                 - for each of the 10 datasets provides 4 text files used in downstream processing.  
                   These give indices and names of input reads, generated ASV sequences, and UMAP 2D
                   coordinates as generated by the Murrell Lab seqUMAP() function for the ASVss and
                   reads.
           iii. denoised_amplicon_D6322_16S23S_05022024_10datasets_ASVs_fastq.tar
                  - filtered fastq files for all 10 datasets as output by RAD.
                  
            iv. blastn_RAD_datasets_11_20_07022024A.tar (and ....07022024B.tar)
                  - 10 text files from blastn (1 per dataset) that give alignment data of ASVs against the 
                     reference database which is processed by the authors' code
                         species_strain_analysis_residualAmbiguity_v02.R
                     to give species and strain identification and quantification

CAVEAT: This code body is not intended for large scale production runs - it is code written
        to research a question on feasibility of improved use of nanopore-accuracy amplicon
        analysis of bacterial microbiome data.


