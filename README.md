# Nanopore_Microbiome_WEHI_cjw
# Microbiome analysis via nanopore-sequenced amplicon data
# Code underpinning draft paper Feb 2024 
# cjw      07 February 2024
Notes for the processing of Nanopore-sequenced Zymo D6322 Mock Microbiome data as 
generated by Sereika et al. to assess the feasibility of sub-species bacterial microbiota 
profiling.  This is support material for the document 
  Full 16S and 23S rRNA gene-based,strain-level resolution of the microbiota of a mock 
  bacterial microbiome using ONT nanopore sequencing.
Authors:-
           Christopher J. Woodruff, Zhengming Zhang and Terence P. Speed
           
There are 3 parts to the processing:-
   1. Generation of 16S and 23 rRNA reference databases;
   2. Extraction of 16S and 23S rRNA gene DNA sequences from a ONT-nanopore-sequenced 
      metagenomic data for the Zymo D6322 mock microbiome to give primary and sub-sampled
      datasets.
   3. Processing of the datasets through denoising, alignment to the relevant reference 
      databases, and use of alignment data to identify and quantify the microbiota.
      
These notes provide guidance on using the code deposited on Github and the various files
provided via Figshare to trace the computational steps and results underpinning the 
material presented in the paper and its Additional Files/Supplementary Data. 

PART 1: Database Generation.
        A set of genome sequences that includes the genomic sequences of the D6322 
        bacteria is sourced. In our case we included approximately 10 additional genomes
        for each D63222 species, randomly selected from those available in NCBI Refseq.
        
        The R script   identify_extract_rrnOperons_workDB_v01.R     is executed to extract
        the 16S and 23S sequences (and Z2 and Z5 sequences should those be of interest) of
        each genome.  This script requires the additional scripts
        
              rrn_operon_in_silico_16S_ITS_23S_primers_04Aug2021.R
              rrn_16S_ITS_23S_boundaries.R
              rrn_fragment_evidence_generation.R
              ITS_subelement_sequences.R
              
        Some characterisation of the extracted sequences for each genome os provided by 
        
                   unique_operons_count.R
                   
        which generates information subsequently used in PART 3.
        
        Actual formation of the blastn database requires a fasta file containing all the 
        sequences of interest, and these sequences must have headers that are no longer 
        than 50 characters.  The code 
        
                   fasta_header_trimmer_for_blastn.R
                   
        trims the headers of fasta sequences to <50 characters as required for blastn 
        databases.
        
        Suppose a fasta file has been created that has the sequences of all 16S rRNA genes
        of interest, and it has the name  my16SworkDB.  The call 
        
             makeblastdb -in my16SworkDB -dbtype nucl -parse_seqids
                      
        will create the set of files that constitute the required blastn database.
            


PART 2: Dataset Generation.
        The datasets generated for this study consisted of 5 16S datasets and 5 
        corresponding 23S datasets.  
        Consider the 16S datasets.  A primary dataset is formed by extracting a 16S rRNA 
        gene sequence from any read found to have one. The Rscript
        
            extract_Sereika_16S23S_v10.R
            
        which requires
                        rrn_operon_in_silico_16S_ITS_23S_primers_04Aug2021.R
                        rrn_16S_ITS_23S_boundaries.R 
                        
        generates fastq files for each of 16S and 23S rRNA gene sequences.  The 16S fastq
        file contains records from any read that was found to have a complete 16S sequence,
        and likewwise for the 23S.  These files are subsequently used as input to the 
        denoiser, RAD (see PART 3).  They are considered the primary datasets in this 
        study.
        
        An additional 4 sub-sampled datasets are generated for each of the 16S and 23S 
        primary dataset.  The sub-sampling code is     
         
            subsample_D6322_fastq_v10.R
            
        This cannot be run until the relevant primary dataset has been processed through
        RAD which outputs a fastq file of reads meeting the length and quality criteria
        specified in the call of RAD.  In this study we have set 4 different sub-sampling
        specifications, common to both the 16S and 23S sub-sampling.
        
        Note that this code is very demanding of computational resources.  As written a 
        block of 250,000 reads of the Sereika et al. D6322 metagenomic dataset takes 
        about 1 hour to run using 56 cores on an HPC cluster.  It is expected that this 
        code would be unnecessary for users at the generation of amplicon sequences would 
        be via laboratory methods and nanopore sequencing of a library prepared from 
        genomic DNA.
             


PART 3: Denoising, ASV alignment, Microbiota Profiling.
        Denoising uses the Murrell labs RAD denoiser, which is written in Julia.  A script
        for doing this was generously provided by Ben Murrell and modified to provide 
        additional output by the lead author of this paper.  That script is 
             
        The script is edited to give the names of the input fastq file of noisy reads, and 
        the various output files, successively for each dataset. 
        
        The RAD output from processing each dataset is used as input to the Rcode 
        
            species_strain_analysis_residualAmbiguity_v01.R
            
        This code aligns each Amplicon Sequence Variant from RAD against every entry in 
        the appropriate database (16S or 23S), using blastn running locally.  The blastn
        output is then processed to estimate the identity and relative abundances of 
        strains present.  This analysis constitutes the core of this study.

CAVEAT: This code body is not intended for large scale production runs - it is code written
        to research a question on feasibility of improved use of nanopore-accuracy amplicon
        analysis of bacterial microbiome data.


